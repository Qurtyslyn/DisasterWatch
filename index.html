<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Disaster Watch</title>
    <!--Leaflet CSS and JS Plugins -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="css/styledLayerControl.css" />
	<script src="src/styledLayerControl.js"></script>
    
    <!-- LeafletGPX plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js" defer></script>-->

    <!-- Leaflet Omnivore Plugin-->
     <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <script src="leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="leaflet.awesome-markers.css">
    <script src="https://kit.fontawesome.com/8064aa9388.js" crossorigin="anonymous"></script>

    <!-- Leaflet Layer Tree Plug in https://github.com/jjimenezshaw/Leaflet.Control.Layers.Tree -->
    <script src="L.Control.Layers.Tree.js"></script>
    <link rel="stylesheet" href="L.Control.Layers.Tree.css" />

    <!--Load Helper Functions file-->
    <script src="helperFunctions.js"></script>

    <!--Stylesheet for map Legend-->
    <link rel="stylesheet" href="css/legend.css" />

    <style>
      #map {
        width: 100%;
        height: 960px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

        document.getElementById("map").style.height = (window.innerHeight - 20) + "px";

        //URL Configs for each source

        var fireURL = 'https://services3.arcgis.com/T4QMspbfLg3qTGWY/arcgis/rest/services/WFIGS_Interagency_Perimeters_Current/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson';
        var CAUrl = "https://cwfis.cfs.nrcan.gc.ca/geoserver/public/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=public:m3_polygons_current&outputFormat=json";
        var earthquakeURL = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson";
        var nwsURL = "https://api.weather.gov/alerts/active?status=actual";
        //var volcanoURL = "https://volcano.si.edu/news/WeeklyVolcanoCAP.xml";
        var hurricaneURL = 'https://www.nhc.noaa.gov/gis/kml/nhc_active.kml';

        //Create Map Base Layers

        //Create Topo layer of the map
        var topo = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        //Create the Streets layer of the Map
        var streets = L.tileLayer( 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 18,
            subdomains: ['a','b','c']
        });

        //Create Imagery Layer of the Map
        var imagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
        });

        //Create the Map, Centered on US
        map = L.map('map', {
            center: [39.8283, -98.5795],
            zoom: 5,
            layers: [topo],
            doubleClickZoom: false,
            worldCopyJump: true
        });

        //Create Background Options for the Map Menu
        var backgrounds = [
            {
                groupName : "Background Map",
                expanded : true,
                layers : {
                    "Topographic" : topo,
                    "Basic" : streets,
                    "Satellite" : imagery
                }
            }
          ];

        //Add Base Layers Selection Tree
        var baseTree = {label: 'Base Layers',
            children: [
                {
                    label: 'Topographic',
                    layer: topo
                },
                {
                    label: 'Basic',
                    layer: streets
                },
                {
                    label: 'Satellite',
                    layer: imagery
                }
            ]
        };

        //Create Legend
        var legend = L.control({ position: "bottomleft" });

        legend.onAdd = function(map) {
            var div = L.DomUtil.create("div", "legend");
            div.innerHTML += "<h4>Legend</h4>";
            div.innerHTML += '<span id="Earthquake"><span class="symbol round earthquake"></span><span>Earthquake</span></span><br>';
            div.innerHTML += '<span id="Fire"><span class="symbol fire"></span><span>Wildfire</span></span><br>';
            //div.innerHTML += '<i class="icon" style="background-image: url(https://d30y9cdsu7xlg0.cloudfront.net/png/194515-200.png);background-repeat: no-repeat;"></i><span>Gr√¶nse</span><br>';

            return div;
        };

        legend.addTo(map);

        //Add Overlay Options to Selection Tree
        var overlayTree = {label: 'Incidents', children: []};

        var group = new L.LayerGroup();

        //Add Fire Layer to Map
        const response = fetch(fireURL).then(response => response.json()).then(response => {
            L.geoJson(response, {
                style: function(feature) {
                    //Set Opacity of the fill based on the Containment percentage of the fire
                    var opacity = 1 -(feature.properties.attr_PercentContained / 100)

                    if(opacity < 0.3)
                    {
                        opacity = 0.3;
                    }
                    else if (opacity > 0.65)
                    {
                        opacity = 0.65;
                    }

                    return {color: "#FF0000", fillOpacity: opacity}
                },
                onEachFeature: onEachFeatureFire
            }
            
        ).addTo(group);
        })

        overlayTree.children.push({label: "US Wildfires", layer: group});
        group.addTo(map);


        /*const responseCA = fetch(CAUrl).then(responseCA => responseCA.json()).then(responseCA => {
            L.geoJson(responseCA, {
                style: function(feature) {
                    
                        return {color: "#FF0000"}
                    
                }
                
            }
            
        ).addTo(map);
        })*/

        var EQgroup = new L.LayerGroup();

        //Add Earthquake Layer to Map
        const eqresponse = fetch(earthquakeURL).then(eqresponse => eqresponse.json()).then(eqresponse => {
            L.geoJson(eqresponse, {
                pointToLayer: function (feature, latlng)
                {
                    var color = ""
                    if(feature.properties.mag < 3)
                    {
                        color = "#FF8B01";
                    }
                    else if(feature.properties.mag < 5)
                    {
                        color = "#F55301";
                    }
                    else
                    {
                        color = "#EB1C01";
                    }

                    var options = {
                        radius: 1.8 ** feature.properties.mag,
                        fillColor: color,
                        fillOpacity: 0.5,
                        stroke: false,

                    };

                    return L.circleMarker(latlng, options);
                },
                onEachFeature: onEachFeatureEQ
            
        }).addTo(EQgroup);
        })

        overlayTree.children.push({label: "Earthquakes", layer: EQgroup});
        EQgroup.addTo(map);

        var NWSgroup = new L.LayerGroup();

        //Add NWS Alerts Layer to Map
        const NWSresponse = fetch(nwsURL, {headers: {"accept": "application/geo+json"}}).then(NWSresponse => NWSresponse.json()).then(NWSresponse => {
            L.geoJson(NWSresponse, {
                style: function(feature) {
                    return getPolygonColors(feature.properties.event);
                },
                onEachFeature: onEachFeatureNWS,
                //Filter out alerts that use Zones rather than Polygons for areas
                filter: function(feature, layer) {
                    if(feature.geometry == null)
                    {
                        return false;
                    }
                    else
                    {
                        return true;
                    }
                }
            }
            
        ).addTo(NWSgroup);
        })

        overlayTree.children.push({label: "NWS Alerts", layer: NWSgroup});
        NWSgroup.addTo(map);


        //Add Volcanos to map
        /*const volcanoResponse = fetch(volcanoURL).then((response) => response.text()).then((text) => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, "text/xml");
                    console.log(doc.documentElement.nodeName);
                });*/

        //Add Hurricanes to Map
        omnivore.kml("nhc_active.kml")
            .on('ready', function() {
            // when this is fired, the layer
            // is done being initialized
                console.log("Hurricane Loaded");
            })
            .on('error', function() {
                // fired if the layer can't be loaded over AJAX
                // or can't be parsed
                console.log("Hurricane Failed");
            }).addTo(map);

        //Add Layer to Map
        L.control.layers.tree(baseTree,overlayTree,{selectorBack: true}).addTo(map);

        //Resize the Map to fit the current window size
        function resizeMapWithWindowChange()
        {
            document.getElementById("map").style.height = (window.innerHeight - 20) + "px";
            map.invalidateSize();
        }
        
        window.addEventListener("resize", resizeMapWithWindowChange);

    </script>
  </body>
</html>